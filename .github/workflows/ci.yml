name: Testes de API com Relat√≥rio Allure

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  testes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do reposit√≥rio
      uses: actions/checkout@v4

    - name: Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Configurar Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Dar permiss√£o ao wrapper do Gradle
      run: chmod +x ./gradlew

    - name: Executar Testes
      run: ./gradlew clean test

    - name: Gerar relat√≥rio Allure
      run: ./gradlew allureReport

    - name: üßæ Resumo dos Testes
      if: always()
      run: |
        RESULTS_DIR="build/allure-results"
        REPORT_DIR="build/reports/allure-report"

        if [ ! -d "$RESULTS_DIR" ]; then
          RESULTS_DIR="$REPORT_DIR"
        fi

        FILES_COUNT=$(ls -A "$RESULTS_DIR" 2>/dev/null | wc -l)

        STATUS="${{ job.status }}"
        ICON="‚úÖ"
        MSG="Todos os testes foram executados com sucesso!"
        if [ "$STATUS" != "success" ]; then
          ICON="‚ùå"
          MSG="Alguns testes falharam. Verifique os logs abaixo."
        fi

        {
          echo "## $ICON Relat√≥rio de Testes Allure"
          echo ""
          if [ "$FILES_COUNT" -gt 0 ]; then
            echo "**Arquivos encontrados:** $FILES_COUNT"
          else
            echo "‚ùå Nenhum arquivo de teste encontrado"
          fi
          echo ""
          echo "### üìÅ Artefatos"
          echo "- Resultados: \`$RESULTS_DIR\`"
          echo "- Relat√≥rio HTML: \`$REPORT_DIR\`"
          echo ""
          echo "### üîó Links √öteis"
          echo "- Online: [Abrir Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)"
          echo "- Local: \`./gradlew allureServe\`"
          echo ""
          echo "**Pipeline:** #${{ github.run_number }} | **Branch:** \`${{ github.ref_name }}\`"
          echo "> ‚öôÔ∏è $MSG"
        } >> $GITHUB_STEP_SUMMARY

    - name: Publicar relat√≥rio Allure no GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/reports/allure-report

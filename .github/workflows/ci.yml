name: CI - Testes API com Allure

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout do reposit√≥rio
      uses: actions/checkout@v4

    - name: Configurar JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Gradle dependencies
      uses: actions/cache@v3
      with:
        path: ~/.gradle/caches
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Executar testes e gerar resultados Allure
      run: ./gradlew clean test allureReport --info || true

    - name: Criar pasta do relat√≥rio (garantia)
      run: mkdir -p build/reports/allure-report

    - name: Resumo dos testes no GitHub Actions
      if: always()
      run: |
        RESULTS_DIR="build/allure-results"
        REPORT_DIR="build/reports/allure-report"
        FILES_COUNT=$(ls -A "$RESULTS_DIR" 2>/dev/null | wc -l)
        echo "## üìä Relat√≥rio de Testes Allure" >> $GITHUB_STEP_SUMMARY
        if [ "$FILES_COUNT" -gt 0 ]; then
          echo "‚úÖ Arquivos de resultados encontrados: $FILES_COUNT" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå Nenhum resultado de teste encontrado" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìÅ Artefatos" >> $GITHUB_STEP_SUMMARY
        echo "- Resultados: \`$RESULTS_DIR\`" >> $GITHUB_STEP_SUMMARY
        echo "- Relat√≥rio HTML: \`$REPORT_DIR\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Links √öteis" >> $GITHUB_STEP_SUMMARY
        echo "- Online: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
        echo "- Local: \`./gradlew allureServe\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Pipeline:** #${{ github.run_number }} | **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY

    - name: Publicar relat√≥rio no GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: build/reports/allure-report
        publish_branch: gh-pages
        user_name: 'GitHub Actions'
        user_email: 'actions@github.com'
